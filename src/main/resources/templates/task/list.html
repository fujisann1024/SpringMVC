<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	th:replace="~{_layouts/default :: layout(~{::title}, ~{::main}, 'taskList' , ~{::script})}">

<head>
	<meta charset="UTF-8">
	<title>タスクボード画面</title>

</head>

<body>
	<main>
		<section class="c-file-upload">
			<form class="c-file-upload__form" method="post" th:action="@{/mypage/task/upload}" enctype="multipart/form-data">
				<!-- ファイルアップロード非表示 -->
				<input id="taskUploadFile" 
				       class="c-file-upload__input u-visually-hidden" 
					   type="file" name="file" 
					   accept=".csv" 
					   required>
				<div class="c-file-upload__field">
					<!-- ファイルアップロードの代替UI-->
					<button type="button" class="c-btn js-pick-file">
						ファイル選択(CSV)
					</button>
					
					<!-- 選択済みファイル名 -->
					<span class="c-file-upload__filename"></span>
				</div>
				<div class="c-file-upload__actions">
					<!-- クリアは任意 -->
					<button type="button" class="c-btn c-btn--outline--primaly js-clear-file">クリア</button>
					<!-- 送信は別ボタン：最初は無効 -->
					<button type="submit" class="c-btn c-btn--outline--primaly js-submit-upload" disabled>
						アップロード
					</button>	
				</div>
			</form>
		</section>
		<div class="l-kanban">
			<!-- 日付ごと */-->
			<section class="l-kanban__section" th:each="entry : ${taskSummaryMaps.entrySet()}">
				<h2 class="l-kanban__heading" th:text="${#temporals.format(entry.key,'MM/dd') }">10/11</h2>

				<ul class="l-kanban__list">
					<!-- 1タスク */-->
					<li th:each="task : ${entry.value}">
						<article class="c-kanban-card" th:attr="data-group-id=${task.groupId}">

							<h3 class="c-kanban-card__title" th:text="${task.title}">朝活動</h3>
							<div class="c-kanban-card__time" th:text="${task.startTime} + ' – ' + ${task.endTime}">7:00
								– 9:00</div>

							<span class="c-badge c-badge--kind" th:text="${task.taskKind}">定期作業</span>
							<span class="c-badge" th:classappend="' c-badge--priority-' + ${task.priority}"
								th:text="${task.priority}">高</span>
						</article>
					</li>
				</ul>
				<button class="c-btn c-btn--outline c-btn--block js-open-modal" th:data-date="${entry.key}">
					<span class="c-btn__icon" aria-hidden="true">＋</span>
					<span>新規ワーク</span>
				</button>
				<!--		新規ワークボタン押下時に開くダイアログ		*/-->
				<dialog id="newWorkDialog" class="c-modal" aria-labelledby="newWorkTitle"
					aria-describedby="newWorkDesc">
					<form method="post" th:action="@{/mypage/task/new}" th:object="${taskGroupCreateForm}">
						<h2 id="newWorkTitle">新規ワークを作成</h2>
						<p id="newWorkDesc">タスクの詳細を入力して作成します。</p>

						<!-- クリック元から日付を埋め替える */-->
						<input id="newWorkDate" type="hidden" th:field="*{targetYmd}">

						<!--ラベル左 / 入力右（ワイヤーの2列）*/-->
						<div class="c-modal-form-grid">

							<label for="title">タスク名</label>
							<input id="title" type="text" th:field="*{title}" required>


							<label for="plannedEnd">予定開始時間</label>
							<input id="plannedStart" type="time" th:field="*{plannedStart}" required>


							<label for="plannedEnd">予定終了時間</label>
							<input id="plannedEnd" type="time" th:field="*{plannedEnd}" required>


							<label for="priority">優先度</label>
							<select id="priority" th:field="*{priority}">
								<option value="高">高</option>
								<option value="中">中</option>
								<option value="低">低</option>
							</select>

							<label for="taskKind">タスクの種類</label>
							<select id="taskKind" th:field="*{taskKind}">
								<option value="仕事">仕事</option>
								<option value="定期作業">定期作業</option>
								<option value="その他">その他</option>
							</select>


							<label for="explanation">説明</label>
							<textarea id="explanation" rows="4" th:field="*{explanation}"></textarea>

						</div>
						<div class="c-modal__actions">
							<button type="button" class="c-btn js-close-modal" value="cancel"
								formmethod="dialog">キャンセル</button>

							<button type="submit" class="c-btn c-btn--outline">
								作成する
							</button>
						</div>
					</form>
				</dialog>
			</section>
		</div>



	</main>
	<script>
		$(function () {
			const $dialog = $('#newWorkDialog');
			const dialogEl = $dialog[0];              // HTMLDialogElement を取得
			const $dateInput = $('#newWorkDate');

			// 開く
			$(document).on('click', '.js-open-modal', function (e) {
				e.preventDefault();
				const date = $(this).data('date') || '';
				$dateInput.val(date);          // ← hidden に代入

				if (!dialogEl.open) dialogEl.showModal(); // モーダルで表示
			});

			// 閉じる
			$(document).on('click', '.js-close-modal', function (e) {
				e.preventDefault();

				if (dialogEl.open) dialogEl.close(); // モーダルを閉じる
			});

			// バックドロップクリックで閉じる
			$dialog.on('click', function (e) {
				const r = this.getBoundingClientRect();
				const outside = e.clientX < r.left || e.clientX > r.right ||
					e.clientY < r.top || e.clientY > r.bottom;
				if (outside) this.close('backdrop');
			});
		});
		
		$(function () {
		   const $form  = $('.c-file-upload__form'); //フォーム
		   const $file  = $('#taskUploadFile'); // ファイルアップロードinput
		   const $pick  = $('.js-pick-file'); //選択ファイルボタン
		   const $clear = $('.js-clear-file'); // クリアボタン
		   const $name  = $('.c-file-upload__filename'); // 選択ファイル名
		   const $submit= $('.js-submit-upload'); // アップロードボタン
		
		   // ファイル選択ダイアログを開く
		   $(document).on('click', '.js-pick-file', function (e) {
		     e.preventDefault();
		     $file.trigger('click');
		   });
		
		   // 選択されたらファイル名を表示して送信ボタンを有効化
		   $file.on('change', function () {
		     const f = this.files && this.files[0];
		     if (!f) {
		       $name.text('');
		       $submit.prop('disabled', true);
		       return;
		     }
		
		     // 軽いクライアント検証（必ずサーバでも検証してください）
		     if (!/\.csv$/i.test(f.name)) {
		       alert('拡張子が .csv のファイルを選択してください。');
		       this.value = '';
		       $name.text('');
		       $submit.prop('disabled', true);
		       return;
		     }
		
		     $name.text(f.name);
		     $submit.prop('disabled', false);
		   });
		
		   // クリア
		   $(document).on('click', '.js-clear-file', function (e) {
		     e.preventDefault();
		     $file.val('');
		     $name.text('');
		     $submit.prop('disabled', true);
		   });
		
		   // 送信前の最終チェック（空なら止める）
		   $form.on('submit', function (e) {
		     if (!$file[0].files || !$file[0].files[0]) {
		       e.preventDefault();
		       alert('ファイルを選択してください。');
		     }
		   });
		   
		 });
	</script>

</body>

</html>